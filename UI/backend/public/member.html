<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SmartClub - Thành viên</title>

  <!-- CSS & Icons -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  
  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <!-- CryptoJS for VNPay signature -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button id="btnLangVI" class="active" onclick="switchLanguage('vi')">VI</button>
    <button id="btnLangEN" onclick="switchLanguage('en')">EN</button>
  </div>

  <div class="container">
    <div class="card">
      <img src="images/logo.png" alt="SmartClub" class="logo" onerror="this.style.display='none'">
      <h2>Xin chào <span id="memberName"></span></h2>

      <!-- ======= MENU DƯỚI CÙNG ======= -->
      <div class="bottom-nav">
        <button onclick="showTab('info')"><i class="fa-solid fa-id-card"></i></button>
        <button onclick="showTab('history')"><i class="fa-solid fa-clock-rotate-left"></i></button>
        <button onclick="showTab('renew')"><i class="fa-solid fa-sync"></i></button>
        <button onclick="showTab('rewards')"><i class="fa-solid fa-gift"></i></button>
        <button onclick="showTab('forgot-card')"><i class="fa-solid fa-key"></i></button>
        <button onclick="showTab('chat')"><i class="fa-solid fa-comments"></i></button>
        <button onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
      </div>

      <!-- ======= TAB: THÔNG TIN THẺ ======= -->
      <div id="info" class="tab-content active">
        <h3>Thông tin thẻ</h3>
        <p><b>Mã thẻ:</b> <span id="cardId">123456</span></p>
        <p><b>Họ tên:</b> <span id="name">Nguyễn Văn A</span></p>
        <p><b>Gói dịch vụ:</b> <span id="plan">Gói 3 tháng</span></p>
        <p><b>Bắt đầu:</b> <span id="start">2025-10-01</span></p>
        <p><b>Hết hạn:</b> <span id="end">2026-01-01</span></p>
        <p><b>Điểm tích lũy:</b> <span id="points">120</span></p>
      </div>

      <!-- ======= TAB: LỊCH SỬ ======= -->
      <div id="history" class="tab-content">
        <h3>Lịch sử ra/vào</h3>
        <div id="historyLoading" class="loading-spinner" style="display: none;"></div>
        <div id="historyEmpty" class="empty-state" style="display: none;">Không có lịch sử ra/vào</div>
        <table id="historyTableContainer">
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Hoạt động</th>
              <th>Cổng</th>
            </tr>
          </thead>
          <tbody id="historyTable">
          </tbody>
        </table>
        <button id="loadMoreHistoryBtn" style="display: none; width: 100%; margin-top: 10px;">Tải thêm</button>
      </div>

      <!-- ======= TAB: GIA HẠN ======= -->
      <div id="renew" class="tab-content">
        <h3>Gia hạn thẻ</h3>
        <p>Chọn gói dịch vụ mới:</p>
        <select id="planSelect">
          <option>1 tháng - 500.000đ</option>
          <option>3 tháng - 1.300.000đ</option>
          <option>6 tháng - 2.400.000đ</option>
          <option>12 tháng - 4.500.000đ</option>
        </select>

        <p>Phương thức thanh toán:</p>
        <select id="paymentSelect">
          <option>Tiền mặt tại quầy</option>
          <option>Chuyển khoản ngân hàng</option>
          <option>Ví điện tử</option>
          <option>Thanh toán qua VNPay</option>
        </select>

        <button onclick="confirmRenew()">Xác nhận gia hạn</button>
        <div id="renewMsg"></div>
      </div>

      <!-- ======= TAB: ĐỔI QUÀ ======= -->
      <div id="rewards" class="tab-content">
        <h3>Đổi quà bằng điểm</h3>
        <div class="points-display">
          <p><b>Điểm hiện tại của bạn:</b> <span id="rewardsCurrentPoints" style="color: #4caf50; font-size: 18px; font-weight: bold;">0</span></p>
        </div>
        <div id="rewardsContainer">
          <p style="text-align: center; color: #999; padding: 20px;">Đang tải danh sách quà...</p>
        </div>
      </div>

      <!-- ======= TAB: QUÊN THẺ ======= -->
      <div id="forgot-card" class="tab-content">
        <h3>Quên thẻ - Passcode tạm thời</h3>
        <div id="forgotCardLoading" class="loading-spinner" style="display: none;"></div>
        
        <div id="forgotCardPasscodeDisplay" style="display: none;">
          <div class="passcode-display">
            <div id="qrCodeContainer" class="qr-code-container"></div>
            <div class="passcode-box">
              <span id="forgotCardPasscodeText">- - - - - - - -</span>
              <button id="btnCopyForgotCard" onclick="copyForgotCardPasscode()" title="Sao chép">
                <i class="fa-solid fa-copy"></i>
              </button>
            </div>
            <p class="passcode-hint">Đưa QR code hoặc passcode này cho bảo vệ tại cổng</p>
            <div class="countdown">
              <span>Còn lại: </span><span id="forgotCardTimeRemaining">24:00:00</span>
            </div>
          </div>
          <button onclick="requestNewForgotCardPasscode()" style="background: #999; margin-top: 15px;">Yêu cầu passcode mới</button>
        </div>

        <div id="forgotCardRequestForm" style="display: none;">
          <p>Nhập mã xác nhận đã được gửi đến <span id="forgotCardContactInfo"></span></p>
          <input type="text" id="forgotCardVerificationCode" placeholder="Nhập mã 6 số..." maxlength="6" pattern="[0-9]*" oninput="this.value = this.value.replace(/\D/g, '').slice(0, 6)">
          <button id="btnVerifyForgotCard" onclick="verifyForgotCardCode()">Xác nhận</button>
          <button onclick="cancelForgotCardRequest()" style="background: #999; margin-top: 10px;">Hủy</button>
          <p class="error" id="forgotCardError" style="display: none;"></p>
        </div>

        <div id="forgotCardEmpty" class="empty-state">
          <p>Bạn chưa có passcode tạm thời</p>
          <button onclick="initForgotCardRequest()">Yêu cầu passcode mới</button>
        </div>
      </div>

      <!-- ======= TAB: CHAT ======= -->
      <div id="chat" class="tab-content">
        <h3>Chat với lễ tân</h3>
        <div id="chatLoading" class="loading-spinner" style="display: none;"></div>
        <div id="chatEmpty" class="empty-state" style="display: none;">Chưa có tin nhắn nào</div>
        <div class="chat-container">
          <div class="chat-box" id="chatBox"></div>
          <div class="chat-input">
            <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar">
            <button id="btnAttach" type="button" onclick="document.getElementById('fileInput').click()" title="Đính kèm file">
              <i class="fa-solid fa-paperclip"></i>
            </button>
            <input id="chatInput" placeholder="Nhập tin nhắn..." onkeypress="handleEnter(event)">
            <button id="btnSend" type="button" onclick="sendMessage()">Gửi</button>
          </div>
          <div id="selectedFileName" style="font-size: 12px; color: #666; margin-top: 5px; display: none;"></div>
        </div>
      </div>

    </div> <!-- /card -->
  </div> <!-- /container -->

  <script src="js/i18n.js"></script>
  <script src="js/api.js"></script>
  <script src="js/main.js"></script>
  <script>
    // Khởi tạo ngôn ngữ khi trang load
    document.addEventListener('DOMContentLoaded', () => {
      initLanguageSwitcher();
      translatePage();
    });

    function initLanguageSwitcher() {
      const currentLang = window.i18n ? window.i18n.getLanguage() : 'vi';
      updateLanguageButtons(currentLang);
    }

    function switchLanguage(lang) {
      if (window.i18n) {
        window.i18n.setLanguage(lang);
        updateLanguageButtons(lang);
        // Translate động không reload
        translatePage();
      }
    }
    
    function translatePage() {
      if (window.i18n) {
        window.i18n.translatePage();
      }
    }

    function updateLanguageButtons(lang) {
      const btnVI = document.getElementById('btnLangVI');
      const btnEN = document.getElementById('btnLangEN');
      if (btnVI && btnEN) {
        if (lang === 'vi') {
          btnVI.classList.add('active');
          btnEN.classList.remove('active');
        } else {
          btnVI.classList.remove('active');
          btnEN.classList.add('active');
        }
      }
    }
  </script>
</body>
</html>
